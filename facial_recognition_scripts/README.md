# Face Recognition Scripts (OpenCV LBPH)

Test scripts for facial recognition to integrate with dish detection system.

**Uses OpenCV's built-in face recognizer** - NO extra packages needed! Works with the OpenCV you already have installed.

## Installation

### On Raspberry Pi

**NO installation needed!** These scripts use:
- OpenCV's Haar Cascades (face detection)
- OpenCV's LBPH Face Recognizer (face recognition)

Both are already included in your `opencv-python` package.

### Verify OpenCV is installed
```bash
python3 -c "import cv2; print(cv2.__version__)"
```

## Usage

### 1. Prepare Training Images

**Option A: Use existing photos from social media**

Create directory structure:
```bash
mkdir -p known_faces
cd known_faces
mkdir PersonName1
mkdir PersonName2
# ... etc for each person
```

Add photos to each person's folder:
```
known_faces/
  PersonName1/
    photo1.jpg
    photo2.jpg
    photo3.jpg
  PersonName2/
    photo1.jpg
    photo2.jpg
  ...
```

**Option B: Capture photos with camera**
```bash
cd face_recognition
python capture_faces_opencv.py "PersonName"
```
- Press **S** to save a photo
- Press **Q** to quit
- Capture 5-10 photos per person from different angles

### 2. Train the Model

```bash
cd face_recognition
python train_faces_opencv.py
```

This will:
- Scan all images in `known_faces/` directory
- Detect faces using Haar Cascades
- Train LBPH recognizer
- Save to `face_recognizer.xml` and `known_faces_opencv.pkl`

Expected output:
```
✓ Loaded model for X people
```

### 3. Test Recognition

```bash
cd face_recognition
python face_recognition_test_opencv.py
```

This will:
- Open camera feed (camera index 4 by default for your 1080p webcam)
- Show live video with face detection boxes
- Display names for recognized faces
- Show "Unknown" for unrecognized faces

**Controls:**
- Press **Q** to quit

## Configuration

Edit settings at the top of each script:

### face_recognition_test_opencv.py
```python
CAMERA_INDEX = 4              # Your 1080p webcam (update if needed)
PROCESS_EVERY_N_FRAMES = 3    # Lower = slower but more accurate
CONFIDENCE_THRESHOLD = 70     # Lower = stricter matching (0-100)
```

**Note:** In LBPH, lower confidence values = better matches. Typical range:
- 0-50: Excellent match
- 50-70: Good match
- 70-100: Poor match
- 100+: Unknown

### capture_faces_opencv.py
```python
CAMERA_INDEX = 4              # Your 1080p webcam (update if needed)
```

## Troubleshooting

### "Could not open camera"
- Check your camera index with: `v4l2-ctl --list-devices`
- Update `CAMERA_INDEX` in the scripts (currently set to 4)
- Test with: `ls /dev/video*`

### "No face found in image"
- Ensure photos have clear, front-facing faces
- Photos should be well-lit
- Haar Cascades work best with frontal faces
- Try different photos with better lighting

### Low FPS / Slow performance
- Increase `PROCESS_EVERY_N_FRAMES` (e.g., 5)
- RPi 4 should get 10-20 FPS easily with this lightweight approach

### Poor recognition accuracy
- Capture MORE photos per person (8-10 instead of 3-5)
- Use varied angles and lighting
- Adjust `CONFIDENCE_THRESHOLD` (try 50 for stricter matching)
- Ensure training photos are good quality
- Make sure faces are well-lit and clearly visible

### "cv2.face.LBPHFaceRecognizer_create() error"
Your OpenCV might not include the contrib modules. Install opencv-contrib:
```bash
pip uninstall opencv-python
pip install opencv-contrib-python --break-system-packages
```

## How It Works

### Technology Stack

**Haar Cascades (Face Detection):**
- Fast, lightweight cascade classifier
- Trained on thousands of positive/negative face images
- Works well on CPU, perfect for Raspberry Pi
- Detects frontal faces reliably

**LBPH (Local Binary Patterns Histograms):**
- Simple yet effective face recognition algorithm
- Divides face into small regions and extracts texture features
- Robust to lighting variations
- Very fast on CPU
- Perfect for small groups (4-6 people)

### Recognition Pipeline

1. **Face Detection**: Haar Cascade detects faces in camera feed
2. **Preprocessing**: Convert to grayscale, resize to 200x200
3. **Training**: LBPH creates histogram features for each person
4. **Recognition**: Compare detected face against trained models
5. **Confidence**: Lower value = better match (threshold: 70)

Simple, fast, and effective!

## Files

- **train_faces_opencv.py** - Build face recognition model from images
- **capture_faces_opencv.py** - Interactive tool to capture training photos
- **face_recognition_test_opencv.py** - Real-time face recognition test
- **known_faces/** - Directory containing training images (create this)
- **face_recognizer.xml** - Trained LBPH model (generated by training)
- **known_faces_opencv.pkl** - Label mapping (generated by training)

## Performance

On Raspberry Pi 4:
- **FPS**: 10-20 FPS typical (very fast!)
- **Memory**: ~100 MB
- **CPU**: 15-30% per core
- **Accuracy**: Good for 4-6 people with varied training photos
- **Installation**: ZERO extra packages!

## Why OpenCV LBPH?

**Tried MediaPipe:** Not available on all Raspberry Pi configurations

**Tried dlib:** Requires 20-30 min compilation, often fails on RPi

**OpenCV LBPH:**
- ✅ Already installed (part of opencv-python)
- ✅ Very fast on Raspberry Pi
- ✅ Good accuracy for small groups
- ✅ Zero dependencies
- ✅ Battle-tested and reliable

## Next Steps

Once face recognition is working well:
1. Integrate with dish detection system
2. Use second camera (index 4) to identify who placed the dish
3. Include person's name in GroupMe alerts
4. Handle edge cases (no face detected, multiple people, unknown person)

## Training Tips

For best results:
- Capture 8-10 photos per person
- Vary angles: front, slight left, slight right
- Vary expressions: neutral, smiling
- Ensure good, consistent lighting
- Avoid sunglasses, hats, or face coverings
- Use similar lighting conditions to final deployment
